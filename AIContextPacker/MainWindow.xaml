<Window x:Class="AIContextPacker.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AIContextPacker"
        mc:Ignorable="d"
        Title="AI Context Packer" Height="800" Width="1400"
        Background="{DynamicResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver">
    
    <Window.Resources>
        <Style TargetType="Button" x:Key="PrimaryButton">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource PrimaryHoverBrush}"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Opacity" Value="0.5"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Button" x:Key="SecondaryButton" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
        </Style>
    </Window.Resources>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top" Background="{DynamicResource SurfaceBrush}">
            <MenuItem Header="File">
                <MenuItem Header="Open Project..." Click="SelectProject_Click"/>
                <Separator/>
                <MenuItem Header="Recent Projects">
                    <!-- TODO: Bind to recent projects list -->
                </MenuItem>
                <Separator/>
                <MenuItem Header="Exit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="Settings" Click="Settings_Click"/>
        </Menu>

        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" 
                Background="{DynamicResource SurfaceBrush}" 
                Padding="10">
            <StackPanel Orientation="Horizontal">
                <Button Content="📁 Select Project Folder" 
                        Style="{StaticResource PrimaryButton}"
                        Click="SelectProject_Click"
                        Margin="0,0,10,0"/>
            
            <TextBlock Text="Max Chars Limit:" 
                       VerticalAlignment="Center" 
                       Margin="20,0,5,0"
                       Foreground="{DynamicResource TextBrush}"/>
            <TextBox Width="100" 
                     Text="{Binding MaxCharsLimit, UpdateSourceTrigger=PropertyChanged}"
                     VerticalAlignment="Center"
                     Padding="5"
                     Margin="0,0,10,0"/>
            
            <TextBlock Text="Global Prompt:" 
                       VerticalAlignment="Center" 
                       Margin="20,0,5,0"
                       Foreground="{DynamicResource TextBrush}"/>
            <ComboBox Width="200" 
                      SelectedValue="{Binding SelectedGlobalPromptId}"
                      DisplayMemberPath="Name"
                      SelectedValuePath="Id"
                      ItemsSource="{Binding GlobalPrompts}"
                      VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - File Selection -->
            <Border Grid.Column="0" 
                    BorderBrush="{DynamicResource BorderBrush}" 
                    BorderThickness="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="4"
                    Padding="10">
                <DockPanel>
                    <!-- Pinned Files Section -->
                    <GroupBox DockPanel.Dock="Top" 
                              Header="📌 Pinned Files (Priority)" 
                              Margin="0,0,0,10"
                              Foreground="{DynamicResource TextBrush}">
                        <ListBox ItemsSource="{Binding PinnedFiles}" 
                                 Height="100"
                                 Background="{DynamicResource BackgroundBrush}"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="📌" 
                                                Command="{Binding DataContext.TogglePinFileCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                BorderThickness="0"
                                                Background="Transparent"
                                                Cursor="Hand"/>
                                        <TextBlock Text="{Binding Name}" 
                                                   VerticalAlignment="Center"
                                                   Margin="5,0"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </GroupBox>

                    <!-- Filter Controls -->
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <TextBlock Text="Ignore Filters:" 
                                   FontWeight="Bold" 
                                   Margin="0,0,0,5"
                                   Foreground="{DynamicResource TextBrush}"/>
                        <ItemsControl ItemsSource="{Binding AvailableFilters}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Name}" 
                                              IsChecked="{Binding IsActive}"
                                              Margin="0,2"
                                              Foreground="{DynamicResource TextBrush}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <CheckBox Content="Use detected .gitignore" 
                                  IsChecked="{Binding UseDetectedGitignore}"
                                  IsEnabled="{Binding HasLocalGitignore}"
                                  Margin="0,5,0,0"
                                  Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>

                    <!-- Selection Buttons -->
                    <StackPanel DockPanel.Dock="Top" 
                                Orientation="Horizontal" 
                                Margin="0,0,0,10">
                        <Button Content="Select All" 
                                Command="{Binding SelectAllCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Margin="0,0,5,0"/>
                        <Button Content="Deselect All" 
                                Command="{Binding DeselectAllCommand}"
                                Style="{StaticResource SecondaryButton}"/>
                    </StackPanel>

                    <!-- File Tree -->
                    <TreeView ItemsSource="{Binding RootNode.Children}"
                              Background="{DynamicResource BackgroundBrush}"
                              Foreground="{DynamicResource TextBrush}"
                              BorderThickness="0">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal" 
                                            Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <CheckBox IsChecked="{Binding IsSelected}" 
                                              Margin="0,0,5,0"/>
                                    <Button Content="📌" 
                                            Command="{Binding DataContext.TogglePinFileCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Visibility="{Binding IsDirectory, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"
                                            BorderThickness="0"
                                            Background="Transparent"
                                            Cursor="Hand"
                                            Padding="2"
                                            Margin="0,0,5,0"/>
                                    <TextBlock Text="{Binding Name}" 
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" 
                          HorizontalAlignment="Stretch" 
                          Background="{DynamicResource BorderBrush}"/>

            <!-- Right Panel - Output -->
            <Border Grid.Column="2" 
                    BorderBrush="{DynamicResource BorderBrush}" 
                    BorderThickness="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="4"
                    Padding="10">
                <DockPanel>
                    <!-- Action Buttons -->
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <Button Content="✨ Generate" 
                                Command="{Binding GeneratePartsCommand}"
                                IsEnabled="{Binding IsGenerateEnabled}"
                                Style="{StaticResource PrimaryButton}"
                                Height="40"
                                FontSize="14"
                                Margin="0,0,0,5"/>
                        <Button Content="📋 Copy Structure" 
                                Command="{Binding CopyStructureCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Height="35"/>
                    </StackPanel>

                    <!-- Generated Parts -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding GeneratedParts}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="{DynamicResource BorderBrush}" 
                                            BorderThickness="1" 
                                            Margin="0,0,0,10"
                                            CornerRadius="4"
                                            Padding="10"
                                            Background="{DynamicResource BackgroundBrush}">
                                        <StackPanel>
                                            <TextBlock FontWeight="Bold" 
                                                       Margin="0,0,0,5"
                                                       Foreground="{DynamicResource TextBrush}">
                                                <Run Text="Part "/>
                                                <Run Text="{Binding PartNumber}"/>
                                            </TextBlock>
                                            <TextBlock Margin="0,0,0,10"
                                                       Foreground="{DynamicResource SecondaryTextBrush}">
                                                <Run Text="Characters: "/>
                                                <Run Text="{Binding CharacterCount}"/>
                                                <Run Text=" / "/>
                                                <Run Text="{Binding MaxChars}"/>
                                            </TextBlock>
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="📋 Copy" 
                                                        Command="{Binding DataContext.CopyPartCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource PrimaryButton}"
                                                        Margin="0,0,5,0"/>
                                                <Button Content="🔎 Preview" 
                                                        Click="PreviewPart_Click"
                                                        Tag="{Binding}"
                                                        Style="{StaticResource SecondaryButton}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
